<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Photo Interrupter - MSA Summer School: IoT Predictive Maintenance</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././theme/pagetoc.css">
        <link rel="stylesheet" href=".././theme/css/mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/css/code.css">
        <link rel="stylesheet" href=".././theme/css/terminal.css">
        <link rel="stylesheet" href=".././theme/css/output.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="burgundy">Burgundy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="dracula">Dracula</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ecoFriend">EcoFriend</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="pinkrose">Pinkrose</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="space">Space</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="sustain">Sustain</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="tokyonight">Tokyonight</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MSA Summer School: IoT Predictive Maintenance</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/uniofgreenwich/MSA-Summer-School" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/uniofgreenwich/MSA-Summer-School/edit/main/src/ESP8266/Photo_Interrupter.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main><div class="sidetoc"><nav class="pagetoc"></nav></div>
                        <h1 id="photo-interrupter"><a class="header" href="#photo-interrupter">Photo Interrupter</a></h1>
<p>The KTIR6011S is an infrared emitter and phototransistor pair enclosed in a single package. This type of device is commonly used for reflective object sensing, proximity sensing, and encoder applications for instance ot monitor the motors speed by counting the interrupts in via the spokes of a wheel.</p>
<p>In order to understand the this component it is important to review the supporting technical documentation:</p>
<ul>
<li><a href="../../Data_Sheets/ktir0611s.pdf">KTIR0611S Photo Interrupter Datasheet</a></li>
<li><a href="../../Data_Sheets/lm2917-n.pdf">LM2917 Frequency to Voltage Converter</a></li>
</ul>
<div align=center>
<img src="./figures/ktir0611s.jpg" alt="ktir6011s sensor" width=30%>
</div>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note"></a>
</div>
<div>
<p><strong>Note:</strong> No external libraries needed for this</p>
</div>
</div>
<h2 id="developing-the-script"><a class="header" href="#developing-the-script">Developing the script</a></h2>
<ol>
<li>
<p>Create a new a script call it something meaningful like, <code>motor_speed.ino</code></p>
</li>
<li>
<p>Start by adding the standard header information about the script</p>
 <div id="admonition-code" class="admonition admonish-code" role="note" aria-labelledby="admonition-code-title">
 <div class="admonition-title">
 <div id="admonition-code-title">
<p>Code</p>
 </div>
 <a class="admonition-anchor-link" href="#admonition-code"></a>
 </div>
 <div>
<pre><code class="language-cpp">/*
* AUTHORS: YOUR NAMES
* VERSION: 1.0.0
* NOTES: 
*      - Motor Speed is calculated using the Ktir0611s Photo Interrupter
*      - Motor will go forward, reverse and then stop in a loop and 
*        show speed in RPM
*/
</code></pre>
 </div>
 </div>
</li>
</ol>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note-1"></a>
</div>
<div>
<p>If you see <code>...</code> that means that other code is hidden for brevity</p>
</div>
</div>
<ol start="3">
<li>
<p>Next we need to set the global variables needed throughout the script:</p>
 <div id="admonition-code-1" class="admonition admonish-code" role="note" aria-labelledby="admonition-code-1-title">
 <div class="admonition-title">
 <div id="admonition-code-1-title">
<p>Code</p>
 </div>
 <a class="admonition-anchor-link" href="#admonition-code-1"></a>
 </div>
 <div>
<pre><code class="language-cpp">...

// set variables 
const int noise_threshold = 20;
const float motor_speed_conversion_factor = 24.6;
float motor_speed;
</code></pre>
 </div>
 </div>
</li>
<li>
<p>Now we can sort of the setup block so that we permentatly set the mux to the right channel and baudrate for the Serial:</p>
 <div id="admonition-code-2" class="admonition admonish-code" role="note" aria-labelledby="admonition-code-2-title">
 <div class="admonition-title">
 <div id="admonition-code-2-title">
<p>Code</p>
 </div>
 <a class="admonition-anchor-link" href="#admonition-code-2"></a>
 </div>
 <div>
<pre><code class="language-cpp">...
void setup(){
  // initialise the serial
  Serial.begin(9600);
  
  pinMode(D0, OUTPUT);  //PWM
  pinMode(D3, OUTPUT);  //Mux A
  pinMode(D4, OUTPUT);  //Mux B
  pinMode(D5, OUTPUT);  //Direction
  pinMode(A0, INPUT);   //Analogue input

  //Motor speed reading
  digitalWrite(D3, LOW);
  digitalWrite(D4, LOW);
}
</code></pre>
 </div>
 </div>
</li>
<li>
<p>Penultimately we are going to fill the void loop with the core functionality of programme:</p>
 <div id="admonition-note-2" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-2-title">
 <div class="admonition-title">
 <div id="admonition-note-2-title">
<p>Note</p>
 </div>
 <a class="admonition-anchor-link" href="#admonition-note-2"></a>
 </div>
 <div>
<pre><code> we will write the `calculateSpeed()` after this step.
</code></pre>
 </div>
 </div>
 <div id="admonition-code-3" class="admonition admonish-code" role="note" aria-labelledby="admonition-code-3-title">
 <div class="admonition-title">
 <div id="admonition-code-3-title">
<p>Code</p>
 </div>
 <a class="admonition-anchor-link" href="#admonition-code-3"></a>
 </div>
 <div>
<pre><code class="language-cpp">...
void loop(){

  digitalWrite(D5, LOW);  // Motor Forward
  analogWrite(D0, 500);   // you change the speed here
  delay(1000);
  calculateSpeed("Forward");
  

  digitalWrite(D0, LOW);  // Motor Stop
  analogWrite(D5, LOW);
  delay(1000);
  calculateSpeed("Stop");  


  digitalWrite(D0, LOW);  // Motor Reverse
  analogWrite(D5, 500);   // you change the speed here
  delay(1000);
  calculateSpeed("Reverse");


  digitalWrite(D0, LOW);  // Motor Stop
  analogWrite(D5, LOW);
  delay(1000);
  calculateSpeed("Stop");  
}
</code></pre>
 </div>
 </div>
</li>
<li>
<p>Finally, we can add write the bit of code tha calcualtes the motor speed based on the number of...</p>
 <div id="admonition-code-4" class="admonition admonish-code" role="note" aria-labelledby="admonition-code-4-title">
 <div class="admonition-title">
 <div id="admonition-code-4-title">
<p>Code</p>
 </div>
 <a class="admonition-anchor-link" href="#admonition-code-4"></a>
 </div>
 <div>
<pre><code class="language-cpp">void calculateSpeed(){
    // read 
    motor_speed = analogRead(A0);
    delay(500);

        //Eliminate analogue input noise give motor chance to slow down/speed up
    if (motor_speed &lt; noise_threshold) {
        motor_speed = 0;
    }

    //Calibrate motor speed
    motor_speed = motor_speed * motor_speed_conversion_factor;
    Serial.print(motor_speed);
    Serial.println(" RPM");
}
</code></pre>
 </div>
 </div>
 <div id="admonition-note-3" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-3-title">
 <div class="admonition-title">
 <div id="admonition-note-3-title">
<p>Note</p>
 </div>
 <a class="admonition-anchor-link" href="#admonition-note-3"></a>
 </div>
 <div>
<p>The <code>motor_speed_conversion_factor</code> value of 24.6 is the result of a the LM2917 (U4) frequency to voltage converter. The converter ouptsa  voltage that is proportional to the input frequency and is scaled by the value 24.6 to the the rpm.</p>
 </div>
 </div>
</li>
<li>
<p>If you run the code you should see the following output:</p>
<p><img src="./figures/motor_speed_serial.png" alt="" /></p>
</li>
<li>
<p>Try experimenting with the motor speed via the <code>anologWrite()</code> function:</p>
<ul>
<li><code>analogWrite(D5, 500);</code>, where 500 is the DAC value that will map to 1.7v
<ul>
<li>0v - 3.2v map to 0 to 1024 DAC value</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr />
<h2 id="full-code-below"><a class="header" href="#full-code-below">Full code below</a></h2>
<details id="admonition-click-here" class="admonition admonish-code" role="note" aria-labelledby="admonition-click-here-title">
<summary class="admonition-title">
<div id="admonition-click-here-title">
<p>Click here:</p>
</div>
<a class="admonition-anchor-link" href="#admonition-click-here"></a>
</summary>
<div>
<pre><code class="language-cpp">/*
* AUTHORS: YOUR NAMES
* VERSION: 1.0.0
* NOTES: 
*      - Motor Speed is calculated using the Ktir0611s Photo Interrupter
*      - Motor will go forward, reverse and then stop in a loop and show speed in RPM
*/

// set variables 
const int noise_threshold = 20;
const float motor_speed_conversion_factor = 24.6;
float motor_speed;

void setup(){
  // initialise the serial
  Serial.begin(9600);
  
  pinMode(D0, OUTPUT);  //PWM
  pinMode(D3, OUTPUT);  //Mux A
  pinMode(D4, OUTPUT);  //Mux B
  pinMode(D5, OUTPUT);  //Direction
  pinMode(A0, INPUT);   //Analogue input

  //Motor speed reading
  digitalWrite(D3, LOW);
  digitalWrite(D4, LOW);

}

void loop(){

  digitalWrite(D5, LOW);  // Motor Forward
  analogWrite(D0, 500);   // you change the speed here
  delay(1000);
  calculateSpeed("Forward");
  

  digitalWrite(D0, LOW);  // Motor Stop
  analogWrite(D5, LOW);
  delay(1000);
  calculateSpeed("Stop");  


  digitalWrite(D0, LOW);  // Motor Reverse
  analogWrite(D5, 500);   // you change the speed here
  delay(1000);
  calculateSpeed("Reverse");
 

  digitalWrite(D0, LOW);  // Motor Stop
  analogWrite(D5, LOW);
  delay(1000);
  calculateSpeed("Stop");  
}

void calculateSpeed(String state){
  // read 
  motor_speed = analogRead(A0);
  delay(500);

  if(motor_speed &lt; noise_threshold){
    motor_speed = 0;
  }

  //Calibrate motor speed
  motor_speed = motor_speed * motor_speed_conversion_factor;
  Serial.print(state);
  Serial.print(": ");
  Serial.print(motor_speed);
  Serial.println(" RPM");
}
</code></pre>
</div>
</details>
                    </main>
                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ESP8266/Temperature.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../ESP8266/Accelerometer.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ESP8266/Temperature.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../ESP8266/Accelerometer.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/pagetoc.js"></script>


    </div>
    </body>
</html>