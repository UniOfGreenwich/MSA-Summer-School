<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>IoT Setup - MSA Summer School: IoT Predictive Maintenance</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Main</li><li class="chapter-item "><a href="../Introduction/Introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item "><a href="../Documentation/Documentation.html"><strong aria-hidden="true">2.</strong> Documentation</a></li><li class="chapter-item "><a href="../Soldering/Soldering_Instructions.html"><strong aria-hidden="true">3.</strong> Soldering Instructions</a></li><li class="chapter-item expanded "><a href="../ESP8266/Set_Up.html"><strong aria-hidden="true">4.</strong> ESP8266</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ESP8266/Set_Up.html"><strong aria-hidden="true">4.1.</strong> ESP8266</a></li><li class="chapter-item "><a href="../ESP8266/Testing_Sensors.html"><strong aria-hidden="true">4.2.</strong> Testing Sensors</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ESP8266/Temperature.html"><strong aria-hidden="true">4.2.1.</strong> Temperature</a></li><li class="chapter-item "><a href="../ESP8266/Photo_Interrupter.html"><strong aria-hidden="true">4.2.2.</strong> Photo Interrupter</a></li><li class="chapter-item "><a href="../ESP8266/Accelerometer.html"><strong aria-hidden="true">4.2.3.</strong> Accelerometer</a></li></ol></li><li class="chapter-item expanded "><a href="../ESP8266/IoT_Setup.html" class="active"><strong aria-hidden="true">4.3.</strong> IoT Setup</a></li><li class="chapter-item "><a href="../ESP8266/Build_WebPage.html"><strong aria-hidden="true">4.4.</strong> Build Webpage</a></li><li class="chapter-item "><a href="../ESP8266/Upload_Running.html"><strong aria-hidden="true">4.5.</strong> Upload and Running</a></li></ol></li><li class="chapter-item "><a href="../Debian_Rock/Debian_Rock.html"><strong aria-hidden="true">5.</strong> Debian Rock C4</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../Debian_Rock/Internet.html"><strong aria-hidden="true">5.1.</strong> Internet</a></li><li class="chapter-item "><a href="../Debian_Rock/Workbook.html"><strong aria-hidden="true">5.2.</strong> Updating Workbook</a></li><li class="chapter-item "><a href="../Debian_Rock/IoT_Network.html"><strong aria-hidden="true">5.3.</strong> IoT Network</a></li><li class="chapter-item "><a href="../Debian_Rock/Python_Script.html"><strong aria-hidden="true">5.4.</strong> Python Script</a></li><li class="chapter-item "><a href="../Debian_Rock/WireShark.html"><strong aria-hidden="true">5.5.</strong> WireShark</a></li></ol></li><li class="chapter-item "><a href="../Security_IoT/Security_IoT.html"><strong aria-hidden="true">6.</strong> Security IoT</a></li><li class="chapter-item "><a href="../Data_Analysis/Data_Analysis.html"><strong aria-hidden="true">7.</strong> Data Analysis</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MSA Summer School: IoT Predictive Maintenance</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="iot-setup"><a class="header" href="#iot-setup">IoT Setup</a></h1>
<p>In this section we are going to put all the functionality together from the previous sections, we will also include the web page provision after this here:</p>
<ul>
<li><a href="./Build_WebPage.html">Building the Web Page</a></li>
</ul>
<p>We need to include various libraries into this programme, if you have been following along from the previous sections you will should have all the but the following libraries, so make sure you download and install the following libraries to be included in the programme:</p>
<ul>
<li>
<p>All of the following are part of the <a href="https://github.com/esp8266/Arduino/tree/master?tab=readme-ov-file">ESP8266 GitHub Repo</a> that you downloaded as part of the <a href="Set_Up.html">ESP8266 setup</a>:</p>
<ul>
<li>
<p><a href="https://github.com/esp8266/Arduino/blob/master/libraries/ESP8266WiFi/src/ESP8266WiFi.h">ESP8266WiFi</a></p>
</li>
<li>
<p><a href="https://github.com/esp8266/Arduino/blob/master/libraries/ESP8266WiFi/src/WiFiServer.h">WiFiClient</a></p>
</li>
<li>
<p><a href="https://github.com/esp8266/Arduino/blob/master/libraries/ESP8266WebServer/src/ESP8266WebServer.h">ESP8266WebServer</a></p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>Note:</strong> You can use the import function within the Arduino software to unzip the folders into <code>/path/to/Arduino/Libraries/</code>, <code>Sketch</code> -&gt; <code>Include Library</code> -&gt; <code>Add</code> .<code>Zip Library...</code>, then navigate to the <code>/path/to/zipped_library</code> to include it.</p>
</blockquote>
<h2 id="developing-the-script"><a class="header" href="#developing-the-script">Developing the script</a></h2>
<ol>
<li>
<p>Create a new a script call it something meaningful like, <code>predictive.ino</code></p>
</li>
<li>
<p>Start by adding the standard header information about the script</p>
<pre><code class="language-cpp">/*
* AUTHORS: YOUR NAMES
* VERSION: 1.0.0
* DESCRIPTION: Motor Control web server ESP8266 as Access Point (IP Address is: 192.168.4.1)
*/
</code></pre>
</li>
<li>
<p>Using the <code>#include</code> directive reference the wire, Adafruit_MMA845, Adafruit_Sensor libraries:</p>
<blockquote>
<p><strong>Note:</strong></p>
<ul>
<li>If you see <code>...</code> that means that other code is hidden for brevity</li>
</ul>
</blockquote>
<pre><code class="language-cpp">...

#include &lt;ESP8266WiFi.h&gt;
#include &lt;WiFiClient.h&gt;
#include &lt;ESP8266WebServer.h&gt;
#include &lt;DHTesp.h&gt;
#include &lt;Wire.h&gt;
#include &lt;Adafruit_MMA8451.h&gt;
#include &lt;Adafruit_Sensor.h&gt;
#include "index.h"
</code></pre>
<blockquote>
<p><strong>Note:</strong></p>
<blockquote>
<ul>
<li>If you are using the Arduino IDE you should be able to hover over the library and it will show the following paths for each library, respectivley to the above:
<ul>
<li>
<p><code>path\to\Arduino15\packages\esp8266\hardware\esp8266\3.1.2\libraries\ESP8266WiFi\src\ESP8266WiFi.h</code></p>
</li>
<li>
<p><code>path\to\Arduino15\packages\esp8266\hardware\esp8266\3.1.2\libraries\ESP8266WiFi\src\WiFiClient.h</code></p>
</li>
<li>
<p><code>path\to\Arduino15\packages\esp8266\hardware\esp8266\3.1.2\libraries\ESP8266WebServer\src\ESP8266WebServer.h</code></p>
</li>
<li>
<p><code>path\to\Documents\Arduino\libraries\DHT_sensor_library_for_ESPx\DHTesp.h</code></p>
</li>
<li>
<p><code>path\to\Arduino15\packages\esp8266\hardware\esp8266\3.1.2\libraries\Wire\Wire.h</code></p>
</li>
<li>
<p><code>path\to\Documents\Arduino\libraries\Adafruit_MMA8451_Library\Adafruit_MMA8451.h</code></p>
</li>
<li>
<p><code>path\to\Documents\Arduino\libraries\Adafruit_Unified_Sensor\Adafruit_Sensor.h</code></p>
</li>
<li>
<p><code>path\to\Temp\arduino-language-server1776684319\build\sketch\index.h</code></p>
</li>
</ul>
</li>
</ul>
</blockquote>
</blockquote>
</li>
<li>
<p>Now we need to set the following global variables and define objects that we can use from Classes:</p>
<pre><code class="language-cpp">...

const float voltage_conversion_factor = 0.004;
const float temperature_conversion_factor = 17.5;
const float temperature_offset = 20;
const float motor_speed_conversion_factor = 24.6;
const int noise_threshold = 20;

float m_Temp, m_Temp_v, a_Temp, a_Temp_v;
float h ,t;
float motor_speed;
float average_vib, rms_vib, x_axis, y_axis, z_axis;
String Motor_state = "Stop";

DHTesp dht;
Adafruit_MMA8451 mma = Adafruit_MMA8451();

//SSID and Password to your ESP Access Point
const char* ssid = "NAME_OF_YOUR_SSID"; // You should up date this to something unique and clean for your SBC to connect to
const char* password = "12345678";

ESP8266WebServer server(80);  //Server on port 80
</code></pre>
<blockquote>
<p><strong>Note:</strong> There are three new variables/objects created that have not come from the other section you have worked through:</p>
<ul>
<li>Firstly, the <code>ssid</code> and <code>password</code> the name and password of our hotspot once it is setup further on in the programme.</li>
<li>Secondly, the <code>ESP8266WebServer server(80);</code> creates an websever set on port 80.</li>
</ul>
</blockquote>
</li>
<li>
<p>We should now modify the <code>setup()</code> function, there are 56 lines of codes and comments (that are very important to the understanding of the code base). Explainations will be provided after the fact that you can look at:</p>
<pre><code class="language-cpp">...

/**
* @brief Initialises the system on startup.
*
* This function sets up the DHT sensor, initialises serial communication,
* configures the Wi-Fi settings for the access point, and assigns the handling
* functions for the web server's root, SBC, and form endpoints. It also
* initialises the GPIO pins for various components like the motor, multiplexer,
* and the MMA8451 accelerometer sensor.
*
* @param none This function does not take parameters.
* @return void
*/
void setup(void) {
    dht.setup(D6, DHTesp::DHT22);

    Serial.begin(9600);
    Serial.println("");
    
    WiFi.mode(WIFI_AP);           //Only Access point
    WiFi.softAP(ssid, password);  //Start HOTspot removing password will disable security

    IPAddress myIP = WiFi.softAPIP (); //Get IP address
    Serial.print("HotSpt IP:");
    Serial.println(myIP); 

    server.on("/", handleRoot);      //Which routine to handle at root location
    server.on("/form", handleForm);  //These request sent when we click on button
    server.begin();                  //Start server

    Serial.println("HTTP server started");

    //Set up ports
    //D1 and D2 SCL and SCA
    pinMode(D0, OUTPUT);  //PWM
    pinMode(D3, OUTPUT);  //Mux A
    pinMode(D4, OUTPUT);  //Mux B
    pinMode(D5, OUTPUT);  //Direction
    pinMode(D6, INPUT);   //Humidity
    pinMode(A0, INPUT);   //Analogue input

    //Set Mux INH to low and unused mux port to low
    //Motor in stop state
    digitalWrite(D5, LOW);
    analogWrite(D0, 0);

    //begin MMA vibration sensor
    mma.begin();
    //Set MMA range
    mma.setRange(MMA8451_RANGE_2_G);
}
</code></pre>
<blockquote>
<p><strong>Note:</strong></p>
<blockquote>
<ul>
<li>The body of comments at the top of the function is presented in a standard called Doxygen that is commonly used to produce documentation for code base, you can see an example here -&gt; <a href=""></a></li>
<li>The lines that show <code>WiFi.mode(WIFI_AP);</code>, <code>WiFi.softAP(ssid, password);</code> set up the WiFi Access Point</li>
<li>This line enables us to get the default IP address in the ESP8266 core <code>IPAddress myIP = WiFi.softAPIP ();</code> 192.168.4.1</li>
</ul>
</blockquote>
</blockquote>
</li>
<li>
<p>Next we will place one line of code inside the the <code>loop()</code>:</p>
<pre><code class="language-cpp">void loop(void) {
  server.handleClient();  //Handle client requests
}
</code></pre>
</li>
</ol>
<ul>
<li>the <code>server</code>, that is serving on port 80, has a function that "handles" the clients various http requests. Uou can see the implementation here -&gt; <a href="https://github.com/esp8266/Arduino/blob/c2f136515a396be1101b261fe7b71e137aef0dce/libraries/ESP8266WebServer/src/ESP8266WebServer-impl.h#L357">handleClient implementation</a></li>
</ul>
<ol start="7">
<li>
<p>The next function you are to create places all of the various testing sections code together with two new bits of code for the IoT part, it will be explained after:</p>
<pre><code class="language-cpp">/**
* @brief Serves the main page and updates it with sensor readings.
*
* This function is called when the root URL of the server is accessed. It reads
* various sensor data including motor speed, motor temperature, ambient temperature,
* humidity, and vibration. The readings are then used to update placeholders in the
* HTML page before sending it to the client's web browser.
*
* @param none Uses global variables and server object to read sensors and send data.
* @return void
*/
void handleRoot() {
  String s = MAIN_page;

  //Motor speed reading
  digitalWrite(D3, LOW);
  digitalWrite(D4, LOW);
  motor_speed = analogRead(A0);
  delay(200);

  //Motor Temp sensor reading
  digitalWrite(D3, HIGH);
  digitalWrite(D4, LOW);
  m_Temp = analogRead(A0);  //Read Analog Voltage of ADC Pin
  m_Temp_v = m_Temp * voltage_conversion_factor;
  m_Temp = ((temperature_conversion_factor * m_Temp_v) - temperature_offset);
  Serial.println(m_Temp);
  delay(200);

  //Amb Temp sensor reading
  digitalWrite(D3, LOW);
  digitalWrite(D4, HIGH);
  a_Temp = analogRead(A0);  //Read Analog Voltage of ADC Pin
  a_Temp_v = a_Temp * voltage_conversion_factor;
  a_Temp = (temperature_conversion_factor * a_Temp_v) - temperature_offset;
  Serial.println(a_Temp);
  delay(200);
  
  //Eliminate analogue input noise
  if (motor_speed &lt; noise_threshold) {
    motor_speed = 0;
  }

  //Calibrate motor speed
  motor_speed = motor_speed * motor_speed_conversion_factor;
  Serial.println(motor_speed);

  //Humidity sensor reading
  h = dht.getHumidity();
  t = dht.getTemperature();
  Serial.println(h);
  Serial.println(t);
  delay(200);

  //Accelerometer
  sensors_event_t event;
  mma.getEvent(&amp;event);
  x_axis = event.acceleration.x;
  y_axis = event.acceleration.y;
  z_axis = event.acceleration.z;
  average_vib = ((sq(x_axis)) + (sq(y_axis)) + (sq(z_axis))) / 3;
  rms_vib = sqrt(average_vib);
  Serial.println(rms_vib);
  delay(200);

  //Convert variables to String then Replace @@temp@@ in HTML with temperaure value
  s.replace("@@m_temp@@", String(m_Temp));
  s.replace("@@a_temp@@", String(a_Temp));
  s.replace("@@humidity@@", String(h));
  s.replace("@@motor_temp@@", String(t));
  s.replace("@@motor_speed@@", String(motor_speed));
  s.replace("@@status@@", Motor_state);
  s.replace("@@vibration@@", String(rms_vib));
  server.send(200, "text/html", s);  //Send webpage to browser

}
</code></pre>
<blockquote>
<p><strong>Note:</strong></p>
<blockquote>
<ul>
<li>You should see that the fist variable is showing an error in reference due to the fact that <code>MAIN_page</code> does not exist in its current context. This will be remedied after this section.</li>
<li>You should also see that we are using regex <code>s.replace(@@m_temp@@", String(m_temp))</code> as part of the <code>String</code> class to replace the default values in the <code>MAIN_page</code> string object <code>s</code> becauase <code>MAIN_page</code> is the text for the html page. In the example provided here, the value of the motor temperature will replace <code>@@m_temp@@</code>.</li>
</ul>
</blockquote>
</blockquote>
</li>
<li>
<p>So now the webpage would display data, but it is non-iteractive. We will add some functionality to handle POST information that will control the motor, such as, direction of the motor, "Forward", "Reverse", and "Stop", the new function is below:</p>
<pre><code class="language-cpp">/**
* @brief Handles the form submission from the web interface.
*
* This function is called when the user submits a form on the web interface.
* It reads the state of the button from the form data and controls the motor
* accordingly. After setting the motor state, it redirects the web browser
* back to the root location.
*
* @param none Uses global server object to access form data.
* @return void
*/
void handleForm() {
  String m_state = server.arg("button");  //Get button state

  if (m_state == "Forward") {
    digitalWrite(D5, LOW);  //Motor Forward
    analogWrite(D0, 500);
    Motor_state = "Forward";
  }
  if (m_state == "Stop") {
    digitalWrite(D0, LOW);  //Motor Stop
    analogWrite(D5, LOW);
    Motor_state = "Stop";
  }
  if (m_state == "Reverse") {
    digitalWrite(D0, LOW);  //Motor Reverse
    analogWrite(D5, 500);
    Motor_state = "Reverse";
  }

  server.sendHeader("Location", "/");  //Send web browser to root location
  server.send(302, "text/html", "");   //Send browser 302 redirect go back to root location
  delay(500);                          //Delay to let motor get up to speed
}
</code></pre>
</li>
<li>
<p>The script will not compile yet, due to the fact that still <code>MAIN_page</code> does not have a reference.  We can do this now, by following the steps in this section: <a href="Build_WebPage.html">Build WebPage</a>.</p>
</li>
</ol>
<hr />
<h2 id="full-code-here"><a class="header" href="#full-code-here">Full Code here</a></h2>
<details>
<summary>Click here...</summary>
<pre><code class="language-cpp">/*
* AUTHORS: YOUR NAMES
* VERSION: 1.0.0
* DESCRIPTION: Motor Control web server ESP8266 as Access Point (IP Address is: 192.168.4.1)
*/

#include &lt;ESP8266WiFi.h&gt;
#include &lt;WiFiClient.h&gt;
#include &lt;ESP8266WebServer.h&gt;
#include &lt;DHTesp.h&gt;
#include &lt;Wire.h&gt;
#include &lt;Adafruit_MMA8451.h&gt;
#include &lt;Adafruit_Sensor.h&gt;

const float voltage_conversion_factor = 0.004;
const float temperature_conversion_factor = 17.5;
const float temperature_offset = 20;
const float motor_speed_conversion_factor = 24.6;
const int noise_threshold = 20;

float m_Temp, m_Temp_v, a_Temp, a_Temp_v;
float h ,t;
float motor_speed;
float average_vib, rms_vib, x_axis, y_axis, z_axis;
String Motor_state = "Stop";

DHTesp dht;
Adafruit_MMA8451 mma = Adafruit_MMA8451();

//SSID and Password to your ESP Access Point
const char* ssid = "NAME_OF_YOUR_SSID"; // You should up date this to something unique and clean for your SBC to connect to
const char* password = "12345678";

ESP8266WebServer server(80);  //Server on port 80

/**
 * @brief initialises the system on startup.
 *
 * This function sets up the DHT sensor, initialises serial communication,
 * configures the Wi-Fi settings for the access point, and assigns the handling
 * functions for the web server's root, SBC, and form endpoints. It also
 * initialises the GPIO pins for various components like the motor, multiplexer,
 * and the MMA8451 accelerometer sensor.
 *
 * @param none This function does not take parameters.
 * @return void
 */
void setup(void) {
  dht.setup(D6, DHTesp::DHT22);

  Serial.begin(9600);
  Serial.println("");
  
  //Change IP address to avoid conflicts with other devices.
  IPAddress ip(192, 168, 0, 12);
  IPAddress gateway(192, 168, 0, 1);
  IPAddress subnet(255, 255, 255, 0);
  
  WiFi.mode(WIFI_AP);           //Only Access point
  WiFi.softAP(ssid, password);  //Start HOTspot removing password will disable security
  WiFi.config(ip, gateway, subnet);

  //IPAddress myIP = WiFi . softAPIP (); //Get IP address
  Serial.print("HotSpt IP:");
  Serial.println(ip);

  server.on("/", handleRoot);      //Which routine to handle at root location
  server.on("/form", handleForm);  //These request sent when we click on button
  server.begin();                  //Start server

  Serial.println("HTTP server started");

  //Set up ports
  //D1 and D2 SCL and SCA
  pinMode(D0, OUTPUT);  //PWM
  pinMode(D3, OUTPUT);  //Mux A
  pinMode(D4, OUTPUT);  //Mux B
  pinMode(D5, OUTPUT);  //Direction
  pinMode(D6, INPUT);   //Humidity
  pinMode(A0, INPUT);   //Analogue input

  //Set Mux INH to low and unused mux port to low
  //Motor in stop state
  digitalWrite(D5, LOW);
  analogWrite(D0, 0);

  //begin MMA vibration sensor
  mma.begin();
  //Set MMA range
  mma.setRange(MMA8451_RANGE_2_G);
}

void loop(void) {
  server.handleClient();  //Handle client requests
}

/**
 * @brief Serves the main page and updates it with sensor readings.
 *
 * This function is called when the root URL of the server is accessed. It reads
 * various sensor data including motor speed, motor temperature, ambient temperature,
 * humidity, and vibration. The readings are then used to update placeholders in the
 * HTML page before sending it to the client's web browser.
 *
 * @param none Uses global variables and server object to read sensors and send data.
 * @return void
 */
void handleRoot() {
  String s = MAIN_page;

  //Motor speed reading
  digitalWrite(D3, LOW);
  digitalWrite(D4, LOW);
  motor_speed = analogRead(A0);
  delay(200);

  //Motor Temp sensor reading
  digitalWrite(D3, HIGH);
  digitalWrite(D4, LOW);
  m_Temp = analogRead(A0);  //Read Analog Voltage of ADC Pin
  m_Temp_v = m_Temp * voltage_conversion_factor;
  m_Temp = ((temperature_conversion_factor * m_Temp_v) - temperature_offset);
  Serial.println(m_Temp);
  delay(200);

  //Amb Temp sensor reading
  digitalWrite(D3, LOW);
  digitalWrite(D4, HIGH);
  a_Temp = analogRead(A0);  //Read Analog Voltage of ADC Pin
  a_Temp_v = a_Temp * voltage_conversion_factor;
  a_Temp = (temperature_conversion_factor * a_Temp_v) - temperature_offset;
  Serial.println(a_Temp);
  delay(200);

  //Eliminate analogue input noise
  if (motor_speed &lt; noise_threshold) {
    motor_speed = 0;
  }

  //Calibrate motor speed
  motor_speed = motor_speed * motor_speed_conversion_factor;
  Serial.println(motor_speed);

  //Humidity sensor reading
  h = dht.getHumidity();
  t = dht.getTemperature();
  Serial.println(h);
  Serial.println(t);
  delay(200);

  //Accelerometer
  sensors_event_t event;
  mma.getEvent(&amp;event);
  x_axis = event.acceleration.x;
  y_axis = event.acceleration.y;
  z_axis = event.acceleration.z;
  average_vib = ((sq(x_axis)) + (sq(y_axis)) + (sq(z_axis))) / 3;
  rms_vib = sqrt(average_vib);
  Serial.println(rms_vib);
  delay(200);

  //Convert variables to String then Replace @@temp@@ in HTML with temperaure value
  s.replace("@@m_temp@@", String(m_Temp));
  s.replace("@@a_temp@@", String(a_Temp));
  s.replace("@@humidity@@", String(h));
  s.replace("@@motor_temp@@", String(t));
  s.replace("@@motor_speed@@", String(motor_speed));
  s.replace("@@status@@", Motor_state);
  s.replace("@@vibration@@", String(rms_vib));
  server.send(200, "text/html", s);  //Send webpage to browser

}

/**
 * @brief Handles the form submission from the web interface.
 *
 * This function is called when the user submits a form on the web interface.
 * It reads the state of the button from the form data and controls the motor
 * accordingly. After setting the motor state, it redirects the web browser
 * back to the root location.
 *
 * @param none Uses global server object to access form data.
 * @return void
 */
void handleForm() {
  String m_state = server.arg("button");  //Get button state

  if (m_state == "Forward") {
    digitalWrite(D5, LOW);  //Motor Forward
    analogWrite(D0, 500);
    Motor_state = "Forward";
  }
  if (m_state == "Stop") {
    digitalWrite(D0, LOW);  //Motor Stop
    analogWrite(D5, LOW);
    Motor_state = "Stop";
  }
  if (m_state == "Reverse") {
    digitalWrite(D0, LOW);  //Motor Reverse
    analogWrite(D5, 500);
    Motor_state = "Reverse";
  }

  server.sendHeader("Location", "/");  //Send web browser to root location
  server.send(302, "text/html", "");   //Send browser 302 redirect go back to root location
  delay(500);                          //Delay to let motor get up to speed
}
</code></pre>
</detials>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ESP8266/Accelerometer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../ESP8266/Build_WebPage.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ESP8266/Accelerometer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../ESP8266/Build_WebPage.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
